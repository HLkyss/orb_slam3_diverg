# 将针孔相机模型真实值转换为kb相机模型真实值
import numpy as np
from scipy.optimize import minimize

# 定义误差函数
def error_function(k):
    k1, k2, k3, k4 = k
    error = 0
    epsilon = 1e-15  # 避免除以零
    fov_degree = 118.9846  # 相机FOV
    fov = np.pi*fov_degree/180
    for theta in np.linspace(epsilon, fov/2, 1000):  # 采样范围，根据theta的定义，应该考虑相机FOV，不同的FOV似乎应该选用不同的范围 @todo 采样数可以小一点吧
        left_side = theta + k1*theta**3 + k2*theta**5 + k3*theta**7 + k4*theta**9
        right_side = np.tan(theta)
        error += (left_side / (right_side + epsilon) - 1)**2  # 累计误差
    return error

# 初始猜测
initial_guess = [0, 0, 0, 0]    #应该不用改，就全0就行

# 优化过程
result = minimize(error_function, initial_guess)

# 输出结果
k1, k2, k3, k4 = result.x
print("k1:", k1, "k2:", k2, "k3:", k3, "k4:", k4)

#结果 （采样数1000）
#FOV60: k1: 0.33281976859392076 k2: 0.13960932573057316 k3: 0.03989596473635706 k4: 0.01052675486171711
#FOV70: k1: 0.33326978589738815 k2: 0.13357567265442208 k3: 0.05504092158690694 k4: 0.02153528048257481
#FOV80: k1: 0.3334579587781099 k2: 0.1319395947891031 k3: 0.057033435272558886 k4: 0.02544940284112337
#FOV85: k1: 0.33354017280716475 k2: 0.13135613883423694 k3: 0.05747478696206408 k4: 0.026733226273574415
#FOV90: k1: 0.33365182803067356 k2: 0.13063104312949045 k3: 0.05800230990598857 k4: 0.027966740336449827
#FOV95: k1: 0.3331097971956228 k2: 0.13663482426105178 k3: 0.039430031198668045 k4: 0.045061907498003755
#FOV100: k1: 0.33297239702335685 k2: 0.13817759352569395 k3: 0.03474475189790228 k4: 0.04920910763841748
#FOV105: k1: 0.33275934964400666 k2: 0.14032252456674088 k3: 0.028851092228065502 k4: 0.05394403162640681
#FOV110: k1: 0.3324219192800569 k2: 0.1434711886378891 k3: 0.020902051835154443 k4: 0.059787099981423716
#FOV115: k1: 0.33187673741673446 k2: 0.14806512046413084 k3: 0.01035332521670772 k4: 0.06686049024483341
#FOV120: k1: 0.3310187184417369 k2: 0.1547337612380027 k3: -0.0037473423861567115 k4: 0.07555809740473861
#FOV125: k1: 0.32973706343339565 k2: 0.16406190892533476 k3: -0.022115934093423707 k4: 0.0860752590389781
#FOV130: k1: 0.32770463430913477 k2: 0.1777739885198773 k3: -0.047139190474194646 k4: 0.09934712587536533
#FOV135: k1: 0.32451890540800454 k2: 0.19782872286736272 k3: -0.08124783329521482 k4: 0.1161897202547352
#FOV140: k1: 0.31949194605227393 k2: 0.22747750338100126 k3: -0.1284254652801168 k4: 0.13795928789134673
#FOV118.9846: k1: 0.33123887892876225 k2: 0.15310495026770257 k3: -0.00044383114715550805 k4: 0.07359668343403605